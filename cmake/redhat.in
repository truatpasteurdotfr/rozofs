if(RPMBUILD_NOTFOUND)
    message(FATAL_ERROR "Cannot find rpmbuild.")
endif(RPMBUILD_NOTFOUND)

set(TGZ_PACKAGE "@CMAKE_CURRENT_BINARY_DIR@/@ROZOFS_SOURCE_PACKAGE_FILE_NAME@.tar.gz")
set(REDHAT_SPEC_FILE "@CMAKE_CURRENT_BINARY_DIR@/rozofs.spec")
set(REDHAT_BUILD "@CMAKE_CURRENT_BINARY_DIR@/rpm/BUILD")
set(REDHAT_RPMS "@CMAKE_CURRENT_BINARY_DIR@/rpm/RPMS")
set(REDHAT_SOURCES "@CMAKE_CURRENT_BINARY_DIR@/rpm/SOURCES")
set(REDHAT_SPECS "@CMAKE_CURRENT_BINARY_DIR@/rpm/SPECS")
set(REDHAT_BUILDROOT "@CMAKE_CURRENT_BINARY_DIR@/rpm/BUILDROOT")

set(BUILDROOT "@CMAKE_CURRENT_BINARY_DIR@/rpm/BUILDROOT")

set(RET_VALUE 0)

if(NOT EXISTS ${TGZ_PACKAGE})
    message(FATAL_ERROR "Cannot find ${TGZ_PACKAGE}: please run package_source target.")
endif(NOT EXISTS ${TGZ_PACKAGE})

# create rpm build area
if(EXISTS @CMAKE_CURRENT_BINARY_DIR@/rpm)
    execute_process(COMMAND rm -rf @CMAKE_CURRENT_BINARY_DIR@/rpm)
endif(EXISTS @CMAKE_CURRENT_BINARY_DIR@/rpm)

execute_process(COMMAND mkdir -p ${REDHAT_BUILD})
execute_process(COMMAND mkdir -p ${REDHAT_RPMS})
execute_process(COMMAND mkdir -p ${REDHAT_SOURCES})
execute_process(COMMAND mkdir -p ${REDHAT_SPECS})
execute_process(COMMAND mkdir -p ${REDHAT_BUILDROOT})

execute_process(COMMAND cp ${TGZ_PACKAGE} ${REDHAT_SOURCES})
execute_process(COMMAND cp ${REDHAT_SPEC_FILE} ${REDHAT_SPECS})

execute_process(COMMAND rpmbuild --define "_topdir @CMAKE_CURRENT_BINARY_DIR@/rpm/" --buildroot ${REDHAT_BUILDROOT} -bb rozafs.spec WORKING_DIRECTORY ${REDHAT_SPECS} RESULT_VARIABLE RET_VALUE)
if(NOT ${RET_VALUE} EQUAL 0)
    MESSAGE( FATAL_ERROR "command rpmbuild failed, RET_VALUE=" ${RET_VALUE} )
endif(NOT ${RET_VALUE} EQUAL 0)

#execute_process(COMMAND cp "${REDHAT_RPMS}/${CMAKE_SYSTEM_PROCESSOR}/*.rpm" "@CMAKE_CURRENT_BINARY_DIR@")
